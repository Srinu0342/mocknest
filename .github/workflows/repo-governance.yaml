name: Enforce Repo Security
on:
  push:
    branches: [ main ]
    paths:
    - '.github/configs/**'

jobs:
  apply-settings:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Apply Rulesets via GH CLI
      env:
        GH_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
      run: |
        # 1. Enable Secret Scanning + Push Protection (correct security_and_analysis structure)
        gh api repos/${{ github.repository }} -X PATCH \
          -f "security_and_analysis[secret_scanning][status]=enabled" \
          -f "security_and_analysis[secret_scanning][push_protection][status]=enabled"

        # 2. Check if the ruleset already exists
        RULESET_ID=$(gh api repos/${{ github.repository }}/rulesets --jq '.[] | select(.name=="Default Safety Rules") | .id')

        if [ -z "$RULESET_ID" ]; then
          echo "Creating new ruleset..."
          gh api repos/${{ github.repository }}/rulesets -X POST --input .github/configs/github-ruleset.json
        else
          echo "Updating existing ruleset $RULESET_ID..."
          gh api repos/${{ github.repository }}/rulesets/$RULESET_ID -m PUT --input .github/configs/github-ruleset.json
        fi
